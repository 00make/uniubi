# Piper机械臂重力补偿程序使用说明

## 概述

重力补偿是机械臂控制中的重要技术，通过计算并抵消重力对机械臂的影响，使机械臂在静止状态下保持平衡，可以轻松手动移动。这对于示教编程、手动调整和柔顺控制非常有用。

## 重力补偿原理

### 1. 基本原理
- 重力补偿通过计算每个关节需要克服重力的力矩来实现
- 主要影响关节2（肩部）和关节3（手臂），因为它们需要承受最大的重力影响
- 通过MIT控制模式应用计算出的补偿力矩

### 2. 实现方法
基于Piper SDK提供的控制方法，重力补偿程序采用以下方式实现：

```python
# 1. 使用MIT控制模式
piper.MotionCtrl_2(0x01, 0x04, 0, 0xAD)

# 2. 对每个关节应用补偿力矩
piper.JointMitCtrl(joint_id, position, velocity, kp, kd, torque)
```

## 程序文件说明

### 1. piper_gravity_compensation.py
- **完整版重力补偿程序**
- 使用完整的动力学模型计算重力力矩
- 包含DH参数、连杆质量和质心位置
- 适合对精度要求较高的应用

### 2. piper_simple_gravity_compensation.py  
- **简化版重力补偿程序**（推荐）
- 使用简化模型，基于关节角度估算重力力矩
- 参数可调，易于调试
- 适合快速部署和调试

## 使用步骤

### 1. 环境准备
```bash
# 确保已安装Piper SDK
pip3 install piper_sdk

# 激活CAN端口
sudo ip link set can0 up type can bitrate 1000000
```

### 2. 运行程序
```bash
# 运行简化版程序（推荐）
python3 piper_simple_gravity_compensation.py

# 或运行完整版程序
python3 piper_gravity_compensation.py
```

### 3. 操作流程
1. 程序启动后会自动连接机械臂
2. 选择运行模式：
   - 直接运行：使用默认参数开始重力补偿
   - 参数调节模式：手动调整补偿参数（首次使用推荐）
3. 机械臂使能后进入重力补偿模式
4. 此时机械臂变得很轻，可以手动移动
5. 按Ctrl+C停止程序

## 参数调节

### 1. 主要参数
- **base_torque**: 基础补偿力矩（N·m）
- **pos_factor**: 位置系数（影响补偿随角度的变化）
- **compensation_gain**: 补偿增益（0-1，控制补偿强度）

### 2. 调节建议

#### 快速调参方法
1. **使用实时调参工具** (`piper_realtime_tuner.py`)
   - 支持实时参数调整
   - 提供快捷键操作
   - 自动保存/加载配置

2. **系统性测试验证** (`piper_parameter_tester.py`)
   - 多位置自动测试
   - 定量稳定性评估
   - 参数优劣对比

#### 分阶段调参策略

**第一阶段：安全初始化**
```python
# 保守起始参数
initial_params = {
    2: {"base_torque": 1.0, "pos_factor": 0.5},  # 肩部从小开始
    3: {"base_torque": 0.5, "pos_factor": 0.3},  # 手臂从小开始
    4: {"base_torque": 0.2, "pos_factor": 0.2},  # 前臂微调
}
compensation_gain = 0.3  # 整体增益从小开始
```

**第二阶段：关节2优化**
```python
# 测试位置序列
test_positions = [
    "水平位置 (θ2=0°)",     # 最大力矩需求
    "45度抬升 (θ2=45°)",    # 中等力矩需求  
    "垂直向上 (θ2=90°)",    # 最小力矩需求
]

# 调节方法：逐步增加base_torque直到各位置平衡
for position in test_positions:
    if "下垂明显": base_torque2 += 0.2
    elif "上抬明显": base_torque2 -= 0.1
    elif "轻微振动": pos_factor2 -= 0.1
```

**第三阶段：关节3协调**
```python
# 在不同θ2下测试θ3补偿
test_combinations = [
    (0°, 0°), (0°, 45°), (45°, 0°), (45°, 45°)
]
# 调节base_torque3和pos_factor3使各组合都平衡
```

### 3. 经验参数范围

#### 不同负载场景
```python
# 标准负载 (无额外工具)
standard_load = {
    2: {"base_torque": 2.0-3.0, "pos_factor": 1.5-2.0},
    3: {"base_torque": 1.0-1.5, "pos_factor": 0.8-1.2},
    4: {"base_torque": 0.2-0.5, "pos_factor": 0.3-0.6},
}

# 轻负载 (工具 < 0.5kg)
light_load = {
    2: {"base_torque": 1.5-2.5, "pos_factor": 1.2-1.8},
    3: {"base_torque": 0.8-1.2, "pos_factor": 0.6-1.0},
    4: {"base_torque": 0.1-0.3, "pos_factor": 0.2-0.4},
}

# 重负载 (工具 > 1kg)  
heavy_load = {
    2: {"base_torque": 3.0-4.5, "pos_factor": 2.0-2.8},
    3: {"base_torque": 1.5-2.5, "pos_factor": 1.0-1.8},
    4: {"base_torque": 0.5-1.0, "pos_factor": 0.4-0.8},
}
```

### 4. 调参工具使用

#### 实时调参工具
```bash
# 启动实时调参工具
python3 piper_realtime_tuner.py

# 快捷键说明
# space: 开始/停止补偿
# w/x: 增加/减少 base_torque  
# a/d: 减少/增加 pos_factor
# z/c: 减少/增加 compensation_gain
# 1-6: 切换关节
# save/load: 保存/加载参数
```

#### 参数测试验证
```bash
# 启动测试工具
python3 piper_parameter_tester.py

# 功能特点
# 1. 全面参数测试 - 多参数集自动对比
# 2. 自定义参数测试 - 验证特定配置
# 3. 定量稳定性评估 - 科学评价效果
```

### 5. 故障诊断

#### 常见问题及解决方案
```python
# 问题1：机械臂振动
if "高频振动":
    solution = "降低kp增益 或 增加kd阻尼 或 减少pos_factor"
    
# 问题2：补偿不足  
if "明显下垂":
    solution = "增加base_torque 或 增加compensation_gain"
    
# 问题3：过度补偿
if "向上漂移":
    solution = "减少base_torque 或 减少compensation_gain"
    
# 问题4：角度敏感
if "某些角度不稳定":
    solution = "调整pos_factor 或 使用分区域参数"
```

### 6. 高级调参技巧

#### 自适应补偿
```python
def adaptive_compensation(joint_angles, load_weight):
    """根据姿态和负载动态调整补偿"""
    base_factor = 1.0
    
    # 姿态影响
    θ2 = joint_angles[1]
    if abs(θ2) < 0.3:  # 接近水平
        base_factor *= 1.2
    elif abs(θ2) > 1.2:  # 接近垂直  
        base_factor *= 0.8
    
    # 负载影响
    load_factor = 1.0 + load_weight * 0.3
    
    return base_factor * load_factor
```

#### 分区域参数
```python
# 根据工作区域使用不同参数
work_zones = {
    "前方区域": {"θ2": (-30, 30), "params": "standard"},
    "侧方区域": {"θ2": (30, 90), "params": "enhanced"},  
    "收缩区域": {"θ2": (45, 90), "params": "reduced"},
}
```

## 安全注意事项

### 1. 使用前检查
- 确保机械臂周围无障碍物
- 确保急停按钮可随时触发
- 首次使用时调小补偿增益

### 2. 运行中注意
- 始终有人在机械臂附近监控
- 发现异常立即按急停或Ctrl+C
- 不要在补偿模式下进行高速运动

### 3. 故障处理
- 如果机械臂抖动：降低补偿增益
- 如果补偿不足：增加相关关节的base_torque
- 如果出现错误：立即停止程序并检查连接

## 控制方法分析

基于提供的代码，Piper机械臂支持以下主要控制方法：

### 1. 基础控制
```python
# 使能/失能
piper.EnablePiper()
piper.DisablePiper()

# 关节位置控制
piper.JointCtrl(joint_0, joint_1, joint_2, joint_3, joint_4, joint_5)

# 末端位置控制
piper.EndPoseCtrl(X, Y, Z, RX, RY, RZ)

# 夹爪控制
piper.GripperCtrl(position, speed, mode, param)
```

### 2. 运动控制模式
```python
# 位置速度模式
piper.MotionCtrl_2(0x01, 0x01, speed_percent, 0x00)

# 直线运动模式
piper.MotionCtrl_2(0x01, 0x02, speed_percent, 0x00)

# 圆弧运动模式  
piper.MotionCtrl_2(0x01, 0x03, speed_percent, 0x00)

# MIT控制模式（用于重力补偿）
piper.MotionCtrl_2(0x01, 0x04, 0, 0xAD)
```

### 3. MIT力矩控制
```python
# MIT控制 - 最适合重力补偿
piper.JointMitCtrl(joint_id, position, velocity, kp, kd, torque)
```

### 4. 状态读取
```python
# 读取关节状态
joint_msgs = piper.GetArmJointMsgs()

# 读取末端位置
end_pose = piper.GetArmEndPoseMsgs()

# 读取机械臂状态
status = piper.GetArmStatus()
```

## 扩展应用

### 1. 示教编程
- 在重力补偿模式下手动移动机械臂
- 记录关键点位置
- 生成轨迹程序

### 2. 柔顺控制
- 结合力传感器反馈
- 实现接触力控制
- 适用于装配作业

### 3. 碰撞检测
- 监测实际力矩与期望力矩的差异
- 检测外部碰撞
- 实现安全保护

## 故障排除

### 1. 常见问题
- **连接失败**: 检查CAN端口配置和线缆连接
- **SDK导入错误**: 确认piper_sdk正确安装
- **权限问题**: 确保有CAN端口访问权限

### 2. 调试技巧
- 使用detect_arm.py检测机械臂连接
- 先运行基础控制示例验证连接
- 逐步增加补偿力矩进行测试

### 3. 参数优化
- 记录不同负载下的最佳参数
- 建立参数数据库
- 根据任务需求选择合适参数

---

*注意：本程序基于Piper SDK V2版本开发，使用前请确保SDK版本匹配。*
