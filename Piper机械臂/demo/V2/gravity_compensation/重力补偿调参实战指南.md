# Piper机械臂重力补偿调参实战指南

## 目录

1. [调参准备](#调参准备)
2. [基础参数说明](#基础参数说明)
3. [分阶段调参流程](#分阶段调参流程)
4. [实用工具使用](#实用工具使用)
5. [常见问题解决](#常见问题解决)
6. [高级调参技巧](#高级调参技巧)
7. [参数备份管理](#参数备份管理)

---

## 调参准备

### 环境准备

1. **硬件检查**
   - 机械臂已正确连接
   - CAN总线通信正常
   - 机械臂位于安全工作区域

2. **软件准备**

   ```bash
   # 确保Python环境正确
   python3 -c "import numpy; print('NumPy版本:', numpy.__version__)"
   
   # 检查SDK连接
   python3 -c "from V2_main import C_PiperInterface_V2; print('SDK导入成功')"
   ```

3. **安全设置**
   - 准备急停按钮
   - 设置合理的力矩限制
   - 确保周围无障碍物

---

## 基础参数说明

### 核心参数定义

```python
gravity_compensation_params = {
    2: {  # 关节2 (肩部关节)
        "base_torque": 2.5,    # 基础补偿力矩 (N·m)
        "pos_factor": 1.8      # 位置系数 (影响角度敏感度)
    },
    3: {  # 关节3 (手臂关节)  
        "base_torque": 1.2,    # 基础补偿力矩 (N·m)
        "pos_factor": 0.9      # 位置系数
    },
    4: {  # 关节4 (前臂关节)
        "base_torque": 0.3,    # 基础补偿力矩 (N·m)
        "pos_factor": 0.4      # 位置系数
    }
}

compensation_gain = 0.8  # 全局补偿增益 (0.0-1.0)
```

### 参数物理意义

- **base_torque**: 在特定基准姿态下的补偿力矩大小
- **pos_factor**: 补偿力矩随关节角度变化的敏感度
- **compensation_gain**: 整体补偿强度的比例控制

---

## 分阶段调参流程

### 第一阶段：安全初始化

#### 目标

建立基础的重力补偿，确保系统稳定运行

#### 初始参数设置

```python
# 保守的起始参数
initial_params = {
    2: {"base_torque": 1.0, "pos_factor": 0.5},  # 肩部从小开始
    3: {"base_torque": 0.5, "pos_factor": 0.3},  # 手臂从小开始  
    4: {"base_torque": 0.2, "pos_factor": 0.2},  # 前臂最小补偿
}
compensation_gain = 0.3  # 整体增益从小开始
```

#### 测试步骤

1. 启动简单重力补偿程序
2. 将机械臂移动到水平位置 (关节2角度≈0°)
3. 观察是否有明显下垂或上抬
4. 如果稳定，进入下一阶段

### 第二阶段：关节2主要优化

#### 目标

优化肩部关节补偿，这是承受重力最大的关节

#### 测试位置序列

```python
test_positions = [
    {"name": "水平位置", "joint2": 0.0, "description": "最大重力矩"},
    {"name": "45度抬升", "joint2": 0.785, "description": "中等重力矩"},
    {"name": "垂直向上", "joint2": 1.57, "description": "最小重力矩"}
]
```

#### 调节方法

```python
# 对每个测试位置进行调节
for position in test_positions:
    print(f"测试 {position['name']}")
    
    # 移动到测试位置
    move_to_position(joint2=position['joint2'])
    
    # 观察现象并调整
    if "下垂明显":
        params[2]["base_torque"] += 0.2
    elif "上抬明显": 
        params[2]["base_torque"] -= 0.1
    elif "轻微振动":
        params[2]["pos_factor"] -= 0.1
    elif "角度敏感":
        params[2]["pos_factor"] += 0.1
```

#### 优化指标

- **稳定性**: 在各测试位置保持静止
- **平滑性**: 位置间移动无突变
- **响应性**: 外力扰动后快速恢复

### 第三阶段：关节3协调优化

#### 目标

在关节2基础上优化关节3，实现多关节协调

#### 测试矩阵

```python
test_combinations = [
    (0.0, 0.0),     # 水平-水平
    (0.0, 0.785),   # 水平-45度
    (0.785, 0.0),   # 45度-水平  
    (0.785, 0.785), # 45度-45度
]

for θ2, θ3 in test_combinations:
    # 测试每种组合的稳定性
    test_position_stability(θ2, θ3)
    adjust_joint3_params()
```

### 第四阶段：精细调节

#### 目标

精细调节所有参数，达到最佳性能

#### 微调策略

```python
# 使用小步长精调
fine_tune_steps = {
    "base_torque": 0.05,  # 每次调整0.05 N·m
    "pos_factor": 0.02,   # 每次调整0.02
    "gain": 0.02          # 每次调整0.02
}

# 性能评估指标
performance_metrics = {
    "position_error": "< 0.01 rad",
    "velocity_noise": "< 0.1 rad/s", 
    "recovery_time": "< 2.0 s"
}
```

---

## 实用工具使用

### 实时调参工具 (piper_realtime_tuner.py)

#### 启动方式

```bash
cd "c:\Users\V100\Documents\GitHub\uniubi\Piper机械臂\demo\V2"
python3 piper_realtime_tuner.py
```

#### 快捷键操作

```
空格键    : 开始/停止重力补偿
数字1-6   : 选择要调节的关节
W/X键     : 增加/减少 base_torque (步长0.1)
A/D键     : 减少/增加 pos_factor (步长0.05)  
Z/C键     : 减少/增加 compensation_gain (步长0.02)
S键       : 保存当前参数配置
L键       : 加载已保存的参数配置
Q键       : 退出程序
```

#### 使用流程

1. 启动程序，按空格键开始补偿
2. 选择关节 (按数字键1-6)
3. 使用快捷键调节参数
4. 观察实时效果
5. 满意后按S键保存

### 参数测试工具 (piper_parameter_tester.py)

#### 功能特点

- **全面参数测试**: 自动测试多组参数组合
- **自定义测试**: 验证特定参数配置  
- **稳定性评估**: 定量分析补偿效果
- **结果对比**: 科学选择最优参数

#### 使用示例

```bash
python3 piper_parameter_tester.py

# 选择测试模式
# 1. 全面参数测试
# 2. 自定义参数测试  
# 3. 稳定性评估
```

#### 测试报告解读

```python
# 测试结果示例
{
    "参数集1": {
        "平均位置误差": 0.008,
        "最大位置误差": 0.015,
        "平均速度噪声": 0.045,
        "稳定性评分": 8.5,
        "推荐度": "优秀"
    }
}
```

---

## 常见问题解决

### 问题诊断表

| 现象 | 可能原因 | 解决方案 |
|------|----------|----------|
| 机械臂振动 | 补偿增益过高 | 降低 `compensation_gain` |
| 明显下垂 | 补偿力矩不足 | 增加 `base_torque` |
| 向上漂移 | 补偿过度 | 减少 `base_torque` |
| 角度敏感 | 位置系数不当 | 调整 `pos_factor` |
| 响应迟缓 | 控制参数过低 | 检查MIT控制参数 |

### 具体解决步骤

#### 解决振动问题

```python
def solve_vibration():
    """解决机械臂振动问题"""
    steps = [
        "1. 降低 compensation_gain 至 0.5 以下",
        "2. 减少 pos_factor 降低角度敏感度",  
        "3. 检查MIT控制的 kp、kd 参数",
        "4. 确认机械标定精度",
        "5. 检查机械间隙和磨损"
    ]
    return steps
```

#### 解决补偿不足

```python  
def solve_insufficient_compensation():
    """解决补偿不足问题"""
    steps = [
        "1. 逐步增加 base_torque (每次+0.1)",
        "2. 增加 compensation_gain 至 0.8-1.0",
        "3. 调整 pos_factor 增加角度补偿",
        "4. 检查负载质量是否超出预期",
        "5. 验证DH参数和重心位置"
    ]
    return steps
```

---

## 高级调参技巧

### 自适应参数调节

#### 负载自适应

```python
def load_adaptive_params(current_load_kg):
    """根据负载重量自适应调节参数"""
    base_params = get_base_params()
    
    # 负载系数
    load_factor = 1.0 + current_load_kg * 0.3
    
    # 调整各关节参数
    adaptive_params = {}
    for joint_id in [2, 3, 4]:
        adaptive_params[joint_id] = {
            "base_torque": base_params[joint_id]["base_torque"] * load_factor,
            "pos_factor": base_params[joint_id]["pos_factor"]
        }
    
    return adaptive_params
```

#### 姿态自适应

```python
def posture_adaptive_compensation(joint_angles):
    """根据当前姿态自适应补偿"""
    θ2 = joint_angles[1]  # 肩部角度
    
    # 姿态影响系数
    if abs(θ2) < 0.3:      # 接近水平
        posture_factor = 1.2
    elif abs(θ2) > 1.2:    # 接近垂直
        posture_factor = 0.8  
    else:                  # 中间位置
        posture_factor = 1.0
        
    return posture_factor
```

### 多区域参数

#### 工作区域划分

```python
work_zones = {
    "前方区域": {
        "range": {"θ1": (-45, 45), "θ2": (-30, 30)},
        "params": {"gain_factor": 1.0, "precision": "high"}
    },
    "侧方区域": {
        "range": {"θ1": (45, 135), "θ2": (0, 60)},  
        "params": {"gain_factor": 1.1, "precision": "medium"}
    },
    "上方区域": {
        "range": {"θ2": (60, 90)},
        "params": {"gain_factor": 0.9, "precision": "medium"}
    }
}
```

### 智能优化算法

#### 梯度下降优化

```python
def gradient_descent_optimization():
    """使用梯度下降法优化参数"""
    learning_rate = 0.01
    max_iterations = 100
    
    for iteration in range(max_iterations):
        # 计算当前误差
        current_error = evaluate_compensation_error()
        
        # 计算梯度
        gradients = compute_parameter_gradients()
        
        # 更新参数
        update_parameters_with_gradients(gradients, learning_rate)
        
        # 检查收敛
        if current_error < convergence_threshold:
            break
```

#### 遗传算法优化

```python
def genetic_algorithm_optimization():
    """使用遗传算法优化参数"""
    population_size = 20
    generations = 50
    mutation_rate = 0.1
    
    # 初始化种群
    population = initialize_random_population(population_size)
    
    for generation in range(generations):
        # 评估适应度
        fitness_scores = evaluate_population_fitness(population)
        
        # 选择、交叉、变异
        new_population = genetic_operations(
            population, fitness_scores, mutation_rate
        )
        
        population = new_population
    
    return get_best_individual(population)
```

---

## 参数备份管理

### 配置文件格式

```json
{
    "version": "1.0",
    "timestamp": "2024-01-15 10:30:00",
    "load_description": "标准负载配置",
    "compensation_gain": 0.8,
    "joint_params": {
        "2": {"base_torque": 2.5, "pos_factor": 1.8},
        "3": {"base_torque": 1.2, "pos_factor": 0.9}, 
        "4": {"base_torque": 0.3, "pos_factor": 0.4}
    },
    "performance_metrics": {
        "position_accuracy": 0.008,
        "stability_score": 8.5,
        "test_date": "2024-01-15"
    }
}
```

### 备份策略

```python
def backup_management():
    """参数备份管理策略"""
    strategies = {
        "按负载备份": "不同工具和负载使用不同配置文件",
        "按工况备份": "高精度、高速度等不同工况分别备份",
        "按时间备份": "定期备份当前最优参数",
        "自动版本": "每次重大修改自动创建新版本"
    }
    return strategies
```

### 配置对比工具

```python
def compare_configurations(config1_path, config2_path):
    """对比两个配置文件的差异"""
    config1 = load_config(config1_path)
    config2 = load_config(config2_path)
    
    differences = {
        "补偿增益差异": abs(config1["compensation_gain"] - config2["compensation_gain"]),
        "关节参数差异": {},
        "性能指标对比": {}
    }
    
    # 详细对比分析...
    return differences
```

---

## 总结

### 调参成功的关键因素

1. **循序渐进**: 从保守参数开始，逐步优化
2. **系统性测试**: 覆盖不同姿态和工况
3. **量化评估**: 使用客观指标评价效果
4. **安全第一**: 始终保持安全意识
5. **记录完整**: 详细记录调参过程和结果

### 推荐调参流程

```
初始化参数 → 基础稳定性测试 → 关节2优化 → 关节3协调 → 
精细调节 → 性能验证 → 参数备份 → 实际应用测试
```

### 性能目标

- **位置精度**: < 0.01 rad
- **速度噪声**: < 0.1 rad/s  
- **恢复时间**: < 2.0 s
- **稳定性评分**: > 8.0

遵循本指南的分阶段流程，结合提供的实用工具，可以高效地完成Piper机械臂重力补偿的参数调节，实现理想的补偿效果。
